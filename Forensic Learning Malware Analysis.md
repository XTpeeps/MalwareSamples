#  Learning Malware Analysis
Author XT. Wrote for log learning note.
[TOC]
| 更新日期   | 编辑 |    内容    | 备注                           |
| ---------- | ---: | :--------: | ------------------------------ |
| 2019-05-23 |   XT | 格式化内容 | 第一次建立更新目录跟踪记录变更 |
| 2019-08-02 |   XT | 新增内容 | add实战分析记录模块增加分析经验记录 |

## 1 配置实验环境 Setting Up the lab environment
Linux: ubuntu 16.04 desktop
Windows: windows 2008

### 1.1 Linux
Linux after install system:
third-party packages: 

```bash
sudo apt-get update
sudo apt-get install python-pip
pip install --upgrade pip

python tools:
sudo apt-get install python-magic
sudo apt-get install upx
sudo pip install pefile
sudo apt-get install yara
sudo pip install yara-python
sudo apt-get install ssdeep
sudo apt-get install build-essential libffi-dev python python-dev \ libfuzzy-dev
sudo pip install ssdeep
sudp apt-get install wireshark 
sudo apt-get install tshark

INetSim(网络状态模拟器)：
sudo su
echo "deb http://www.inetsim.org/debian/ binary/" >/etc/apt/sources.list.d/inetsim.list 
wget -O - --no-check-certifucate http://www.inetsim.org/inetsim-archive-signing-key.asc | apt-key add -
apt update
apt-get install inetsim
```
以上安装完毕，labubuntu 切换仅主机模式

####  LinuxVM config:
1.配置ubuntu静态网络static IP: 192.168.1.100

sudo gedit /etc/network/interfaces
```
auto lo
iface lo inet loopback

auto ens33
iface ens33 inet static
address 192.168.1.100
netmask 225.255.255.0
```
service networking restart
或者重启ubuntu
ifconfig确认
2. 配置ubuntu中的inetsim配置
修改inetsim默认配置：
sudo gedit /etc/inetsim/inetsim.conf
```
在默认配置service_bind区域追加,并注释掉默认配置：
service_bind_address 192.168.1.100
```

配置DNS服务，已用于DNS服务：

```
在配置dns区域追加以下内容并注释掉原默认配置：
dns_default_ip 192.168.1.100
```
运行测试：
```sudo inetsim```
检查配置

3. 配置第三方软件：
python 2.7 (仅限本书)

**check point**
确认windows主机网段：192.168.1.105  DNS：192.168.1.100
测试win和linux之间联通节点

![1555672944518](E:\Studio\Malicious code analysis\Malware Analysis\1555672944518.png)

![1555672906183](E:\Studio\Malicious code analysis\Malware Analysis\1555672906183.png)



### 1.2 WINDOWS
WINDOWS VM config:
主机网络配置：192.168.1.101 DNS:192.168.1.100
关闭Defender（win10/7, win2008没有Windows Defender）:
	Windows Defender 服务需要在虚拟机禁用掉。运行》gpedit.msc》本地计算机策略》计算机配置》管理模板》windows组件》 Windows Defender（Windows10里面叫“Windows Defender防病毒程序”） 
	在右边部分双“关闭WindowsDefender策略”关闭Windows Defender防病毒程序。（下图为Win10的图）
	![1555673578514](E:\Studio\Malicious code analysis\Malware Analysis\1555673578514.png)
配置虚拟机使其允许双向复制粘贴剪切板。
两个虚拟机全部配置完毕，拍摄快照保存初始化状态。此时，linux和windowsVM均配置为Host-Only仅主机模式，并且能够互通。

##### windows安装必要的分析工具
下面是一些可以用来下载恶意文件样本的网站：
Hybrid Analysis: https://www.hybrid-analysis.com/ 
KernelMode.info: http://www.kernelmode.info/forum/viewforum.php?f=16 
VirusBay: https://beta.virusbay.io/ 
Contagio malware dump: http://contagiodump.blogspot.com/ 
AVCaesar: https://avcaesar.malware.lu/ 
Malwr: https://malwr.com/ 
VirusShare: https://virusshare.com/ 
theZoo: http://thezoo.morirt.com/
其他恶意软件样本源你可以在下面的博客中找到：You can find links to various other malware sources in Lenny Zeltser's blog post https://zeltser.com/malware-sample-sources/. 
个人收集工具：



## 静态分析
静态分析不执行程序，从二进制文件获取信息。
静态分析主要包含：
	识别目标样本框架
	恶意文件指纹
	使用反病毒引擎扫描可疑二进制文件
	提取字符，函数或使用file获取目标相关数据
	确定在文件分析过程中的混淆技术
	分类对比恶意文件样本

#### 0x01 确定文件类型
##### 手动方式识别文件类型
工具：
Windows systems, HxD hex editor  (https://mh-nexus.de/en/hxd/)
Linux systems, to look for the file signature, the ```xxd``` command can be used.
##### 工具方式识别文件类型
On Windows, CFF Explorer, part of Explorer Suite (http://www.ntcore.com/exsuite.php), can be used to determine the file type; windows下也可以在网上找到file.exe，通过file进行文件类型识别。
Linux system，the ```file``` command can be used.
##### python方式识别文件类型
python-magic模块
pip install python-magic
```python
import magic
figlet =""
m=magic.open(magic.MAGIC_NONE)
m.load()
try:
    ftype=m.file(sys.argv[1])
    print ftype
except Exception as e:
    figlet = '''File type               Author XT.        '''
    print figlet+"\nUsage: python filemagic.py <file>"
```
Test success on Python 2.7.13 Windows10:
```python
import magic
import sys,os
figlet =""
try:
    file=sys.argv[1]
except Exception as e:
    print "[Debug]Error :"+str(e)
    sys.exit()
if os.path.exists(file):
    try:
        m=magic.from_file(file)
        print m
    except Exception as e:
        print "[Debug]Error :"+str(e)
else:
    figlet = '''File type               Author XT.        '''
    print figlet+"\nUsage: python filemagic.py <file>"
    print "[Error]No such file or directory:", file
    sys.exit()
```
#### 0x02 恶意软件指纹
恶意软件的hash
恶意软件释放的新样本的hash
##### 使用工具获取hash
Linux使用the md5sum, sha256sum, and sha1sum
windows使用HashMyFiles (http://www.nirsoft.net/utils/hash_my_files.html)
##### 使用python获取hash
```python
import hashlib
import sys,os
# https://docs.python.org/2/library/hashlib.html
try:
    file=sys.argv[1]
except Exception as e:
    print "[Debug]Error :"+str(e)
    sys.exit()
if os.path.exists(file):
    try:
        content = open(file,"rb").read()
        print "md5:"+hashlib.md5(content).hexdigest()
        print "sha1:"+hashlib.sha1(content).hexdigest()
        print "sha256:"+hashlib.sha256(content).hexdigest()
    except Exception as e:
        print "[Debug]Error :"+str(e)
else:
    figlet = '''File hash               Author XT.        '''
    print figlet+"\nUsage: python filehash.py <file>"
    print "[Error]No such file or directory:", file
    sys.exit()
```
#### 0x03 病毒扫描
通过多种病毒扫描引擎扫描结果帮助我们更好判断文件样本情况，节约我们分析的时间。
VirusTotal (http://www.virustotal.com)
详情：https://support.virustotal.com/hc/en-us/articles/115005002585-VirusTotal-Graph.
https://support.virustotal.com/hc/en-us/articles/115003886005-Private-Services

```python
import urllib
import urllib2
import json
import sys
hash_value = sys.argv[1]
vt_url = "https://www.virustotal.com/vtapi/v2/file/report"
api_key = "<virustotal api>"
parameters = {'apikey': api_key, 'resource': hash_value}
encoded_parameters = urllib.urlencode(parameters)
request = urllib2.Request(vt_url, encoded_parameters)
response = urllib2.urlopen(request)
json_response = json.loads(response.read())
if json_response['response_code']:
    detections = json_response['positives']
    total = json_response['total']
    scan_results = json_response['scans']
    print "Detections: %s/%s" % (detections, total)
    print "VirusTotal Results:"
    for av_name, av_data in scan_results.items():
        print "\t%s ==> %s" % (av_name, av_data['result'])
else:
    print "No AV Detections For: %s" % hash_value
```




##  动态分析
动态分析过程中，当恶意程序执行的时候，需要监控其行为。目标过程的目标是获取恶意程序行为的实时数据，以及其对操作系统的影响。以下是异形不同种类的监控在动态分析过程中用来获取的信息情况：
	进程监控：涉及到监控进程的行为和检查在病毒执行过程中系统性能的影响
	文件系统监控：应该包括在恶意软件执行过程中实时文件系统监控
	注册表监控：主要包括被恶意软件读写的注册表关键值的访问和改动以及注册表的数据
	网络监控：包括在恶意软件执行过程中的实时的网络状态监控
动态分析工具：
	进程监控工具： Process Hacker (http://processhacker.sourceforge.net/) 能够用于监控进程变化、网络传输概况、磁盘读写概况等。
	进程监控：Process Monitor(https://technet.microsoft.com/en-us/sysinternals/processmonitor.aspx)确定系统交互。crtl+E停止抓取事件，ctrl+x清除事件，ctrl+L过滤事件。
	系统监控活动：Noriben (https://github.com/Rurik/Noriben)便携式，简单，恶意软件分析沙箱,一般需要配合processmonitor
	安装程序监视器：Installspy 
	
* noriben
https://github.com/Rurik/Noriben
Noriben是一个基于Python的脚本，与Sysinternals Procmon一起使用，可以自动收集，分析和报告恶意软件的运行时指标。简而言之，它允许您运行应用程序，点击按键，并获得样本活动的简单文本报告。

Noriben不仅允许您运行类似于沙箱的恶意软件，还可以在您以特定方式手动运行恶意软件以使其运行时记录系统范围的事件。例如，它可以在您运行需要不同命令行选项或用户交互的应用程序时进行侦听。或者，在调试器中单步执行应用程序时观察系统。

虽然Noriben是专为分析恶意软件而设计的，但它也被广泛用于审计正常的软件应用程序。2013年，Tor项目使用它来提供Tor浏览器套件的公共审计

下面是一个调试VM检查恶意软件的视频，其方式仍然是获取沙箱结果（由于鼠标指针关闭5个像素而导致误点击:)）
	
	
https://ghettoforensics.blogspot.com/2013/04/noriben-your-personal-portable-malware.html
	
## 分析步骤
静态分析
1. 样本字符分析
file
2. virtual分析
动态分析
1. 样本机和监控机启动
2. windows启动：process hacker、noriben
3. linux启动：inetsim，wireshark
4. 使用管理员身份运行样本40秒左右
5. 停止noriben、inetsim、wireshark
6. 收集检查理解样本行为


## DLL分析
cff explorer tool	

If you wish to know more about Dynamic-Link Libraries, read the following documents: https://support.microsoft.com/en-us/help/815065/what-is-a-dll and https://msdn.microsoft.com/en-us/library/windows/desktop/ms681914(v=vs.85).aspx.

### 为什么攻击者使用dll
1. dll不能双击运行，需要宿主进程执行。将恶意代码打包进dll，恶意程序作者能够使用任何进程加载他的dll，包括合法的进程例如explorer.exe、winlogon.exe等。这些技术可以帮助隐藏攻击者的行为，并且所有恶意行为将会隐藏在宿主程序下执行。
2. 将dll注入到已经运行的程序将可以帮助攻击者长时间驻留在系统
3. 当dll被一个程序加载进内存空间，dll还拥有整个程序内存的访问权限。从而给它操纵程序功能的能力。例如，攻击者可以注入dll到浏览器程序进程，偷取其重定向API函数的凭证。

### 使用rundll32.exe分析dll
使用动态分析对于判断恶意程序的行为至关重要。对于前面提到的dll需要一个程序进程运行。在windows中rundll32.exe能够被用来运行dll调用一个外部函数。
```
rundll32.exe <full path to dll>,<export function>,optional arguments>
```
与rundll32.exe相关的参数：
full path to dll：指定的dll地址，这个地址不能包含空或者特殊字符
export function:这个函数在dll中并且能够在dll加载之后调用
optional arguments:可选参数
逗号：用来表示dll中的某函数

#### 1. rundll32.exe工作原理
明白rundll32工作原理对于在执行dll时避免一些错误非常重要。当你运行rundll32.exe的时候使用命令行+参数形式执行，当执行rundll32.exe时发生的是:
1. 命令行参数通过rundll32.exe被首先执行；如果语法正确，则rundll32.exe执行
2. 如果语法正确，执行加载提供的dll。作为加载dll的结果，dll切入口函数被执行（这在调用住dllmain）。大部分恶意程序实现他们的恶意代码通过dllmain函数。
3. 在架在dll之后，获取外部函数及调用函数地址。如果函数地址不能被确认，则rundll32.exe中断。
4. 如果可选参数提供，则可选函数将提供额外的扩展函数调用


rundll32详细信息工作原理详解: https://support.microsoft.com/en-in/help/164787/info-windows-rundll-and-rundll32-interface.










# 实战分析记录
linux 192.168.1.100
windows2008 

## 邮件恶意样本中发现新MYMOOD蠕虫传播地址
2019.08.19 流量监测发现附件中存在恶意样本，转人工分析：
### 样本邮件
主题:Delivery reports about your e-mail
发件人:"Returned mail" <MAILER-DAEMON@[......](脱敏)>
收件人:pany@[......](脱敏)
日期:Mon, 19 Aug 2019 05:51:20 +0800
<为防止泄密和保护隐私，已对邮件内容进行屏蔽>
附件1165539.scr

### 样本信息
![](https://blogimage.xtpeeps.cn/1567047252995.png-A)

![1567047275649](https://blogimage.xtpeeps.cn/1567047275649.png-A)

![1567047252995](https://blogimage.xtpeeps.cn/1567047252995.png)

![1567047290833](https://blogimage.xtpeeps.cn/1567047290833.png)

通过回溯该攻击者行为，可以发现其历史共进行攻击4次，涉及2个样本，8e1ca3dcdc1d470337dd735e0da71c81、7bad48ed8f8227deb13539379761d837。

### 动态分析：其前台无痕迹，25端口发送大量恶意邮件。

![img](https://blogimage.xtpeeps.cn/clip_image002.jpg)

在对样本7bad48ed8f8227deb13539379761d837（document.zip）的手动分析中发现其在执行之后会进行恶意伪造邮箱程序db6488afd97fb0f8ba0887c99c86b79e3173f9da1b4dbe39ebe3af0faea34a63（主程序document.bat）并传播恶意文件。

![img](https://blogimage.xtpeeps.cn/clip_image004.jpg)

 

通过还原发现其，向外发送形如下的邮件回传信息。

![img](https://blogimage.xtpeeps.cn/clip_image006.jpg)

可以看到样本执行后对外发送大量邮件传递信息，或恶意邮件传播。

![img](https://blogimage.xtpeeps.cn/clip_image008.jpg)

![img](https://blogimage.xtpeeps.cn/clip_image010.jpg)

通过分析其邮件内容发现在对外发起的各类伪造邮件中发现大量进行对外蠕虫类攻击行为。

 ![img](https://blogimage.xtpeeps.cn/clip_image014.jpg)

不到半小时发邮件50多条，发送附件110多条。在对发件内容分析过程中发现，样本在执行之后会将受感染主机作为发件人，并通过布置邮件服务对外发起欺骗类恶意传播邮件和垃圾邮件。

针对恶意样本的批量检测：

![img](https://blogimage.xtpeeps.cn/clip_image016.jpg)

![img](https://blogimage.xtpeeps.cn/clip_image018.jpg)

传播样本：3cf49ce369ca677021efa21436db06a55ad39ae95c6aec20fd8ed8c95c0c8feb、

fa1566a4335787ea408e33c21c7f2001ff91f3b71af57a26f4a5a64b10c856f6对样本的威胁情报分析可知其符合Mydoom恶意邮箱行为。

 

 

根据MyDoom的另一个特点是试图通过TCP端口1042连接到其他IP地址验证样本存在其行为：

![img](https://blogimage.xtpeeps.cn/clip_image020.jpg)

 

根据行业前人总结mydoom是在2004年，mydoom今天仍然活跃。这些年来尽管基于恶意软件的电子邮件中有存在mydoom的比例并不高，仍然有许多基础设施受到感染。

 

根据数据统计，mydoom感染的基础设施主要位于中国的IP地址，而美国则处于第二位。中国和美国都是mydoom电子邮件的主要针对国家。高科技是该病毒最针对的行业。

 

这一蠕虫病毒曾被列为十大最具破坏性的计算机病毒，造成过百亿损失。虽然现在已经过了鼎盛时期，但该病毒对网络安全仍有很大威胁。虽然没有其他恶意软件家族显眼，但在过去的几年里，mydoom仍然活动频繁，约占所有带有恶意软件附件邮件的1.1%。我们每月记录近数万个mydoom样本。绝大多数mydoom电子邮件来自中国IP地址。这些电子邮件发送给世界各地的接收者，该病毒主要针对高科技、批发、零售、医疗、教育和制造业。

 

相关文章：https://www.freebuf.com/articles/network/209777.html

### IOCs：
Hash:
3cf49ce369ca677021efa21436db06a55ad39ae95c6aec20fd8ed8c95c0c8feb
a92164c0c7c488c77631303dd51c9b94ca56ece027fc72231700d65ebada620a
e4d18918d4867c28121489b3a5e17e1996981e2535e68042a07bb232c2ed5163
fa1566a4335787ea408e33c21c7f2001ff91f3b71af57a26f4a5a64b10c856f6
ip：
138.209.176.120
129.81.238.207
138.209.54.87







